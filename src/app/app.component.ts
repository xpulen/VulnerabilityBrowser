import {Component, OnInit} from '@angular/core';
import {HttpClient, HttpParams} from '@angular/common/http';
import {FusekiResponseModel} from './fusekiResponse.model';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: [
    './app.component.css'
  ]
})
export class AppComponent implements OnInit {
  title = 'VulnerabilityBrowser';
  // TODO: make these 3 private
  childrenQuery: FusekiResponseModel;
  parentQuery: FusekiResponseModel;
  searchQuery: FusekiResponseModel;
  searchInput = '';
  itemTitle = '';

  constructor(private http: HttpClient) {
  }

  ngOnInit() {

  }

  runQueries(obj: string) {
    this.itemTitle = obj;
    this.getChildren(obj);
    this.getParents(obj);
  }

  getChildren(obj: string) {
    let searchParams = new HttpParams();
    searchParams = searchParams.append('query',
      'SELECT ?subject ?predicate ?object ' +
      'WHERE {' +
      `${obj} ?predicate ?object` +
      '}' +
      'LIMIT 25');
    searchParams = searchParams.append('output', 'json');
    this.http
      .get<FusekiResponseModel>(
        'http://147.175.121.215:3030/cve-oval-cwe/sparql',
        {
          params: searchParams
        }
      )
      .subscribe((res: FusekiResponseModel) => {
        this.childrenQuery = this.formatAny(res);
      });
  }

  getParents(obj: string) {
    let searchParams = new HttpParams();
    searchParams = searchParams.append('query',
      'SELECT ?subject ?predicate ?object ' +
      'WHERE {' +
      `?subject ?predicate ${obj}` +
      '}' +
      'LIMIT 25');
    searchParams = searchParams.append('output', 'json');
    this.http
      .get<FusekiResponseModel>(
        'http://147.175.121.215:3030/cve-oval-cwe/sparql',
        {
          params: searchParams
        }
      )
      .subscribe((res: FusekiResponseModel) => {
        this.parentQuery = this.formatAny(res);
      });
  }

  searchForKeyword() {
    let searchParams = new HttpParams();
    searchParams = searchParams.append('query',
      'SELECT ?subject ?predicate ?object ' +
      'WHERE {' +
      '?subject ?predicate ?object' +
      ` FILTER regex(?object, "${this.searchInput}", "i") ` +
      '}' +
      'LIMIT 25');
    searchParams = searchParams.append('output', 'json');
    this.http
      .get<FusekiResponseModel>(
        'http://147.175.121.215:3030/cve-oval-cwe/sparql',
        {
          params: searchParams
        }
      )
      .subscribe((res: FusekiResponseModel) => {
        this.searchQuery = this.formatAny(res);
      });
  }

  formatAny(res: FusekiResponseModel) {
    for (const entry of res.results.bindings) {
      if (entry.hasOwnProperty('subject')) {
        entry.subject.value_pretty = entry.subject.value.replace('http://FEI-STU/TP2019/', '');
      }
      if (entry.hasOwnProperty('predicate')) {
        entry.predicate.value_pretty = entry.predicate.value.replace('http://FEI-STU/TP2019/', '');
      }
      if (entry.hasOwnProperty('object')) {
        entry.object.value_pretty = entry.object.value.replace('http://FEI-STU/TP2019/', '');
      }
    }
    console.log(res);
    return res;
  }
}
